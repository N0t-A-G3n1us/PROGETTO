<!DOCTYPE html>

<html>

	<head>

		<meta charset="ISO-8859-1"/>

		<style>

			input {
				font-size:150%;

			}

			button {
				font-size:200%;
				color: blue;
			}

			p {
				font-size:150%;
			}

		</style>

		<script type = "text/javascript" language="javascript">

			var args=window.location.search.substr(1).toString().split("=");
			var MyNomeUtente = args[1].split('&')[0];
			var MyPunteggio = args[2];

			function inizializzaClassificaUtenti(){
				if (typeof(localStorage.utenti) == "undefined") {
					localStorage.utenti="[]";
				}
			}

			function resetClassificaUtenti(){
				localStorage.utenti="[]";
			}

			function stampaClassifica(){
				var u = JSON.parse(localStorage.utenti);
				var l = u.length <= 10 ? u.length : 10;

				var s = new String("<h3>CLASSIFICA ATTUALE:</h3>");
				s += "<table border=\"1\">";
				s += "<th> NICKNAME</th>" + "<th> SCORE </th>";

				for (i=0;i<l;i++){
					s += "<tr>";

					var stringed = JSON.stringify(u[i]);
					s += "<td>";
					var nick=stringed.split(',')[0].split(':')[1];

					console.log( stringed.split(',') )
					s += u[i].nick;
					s += "</td>";
					s += "<td>";
					s += u[i].score;
					s += "</td>";
					s += "</tr>";
				}
				s += "</table>"
				document.getElementById("vistaStorage").innerHTML = s;
				return true;
			}

			function ordina(u){	//costo O(n^2) per array piccolo ragionevole
				var l = u.length;
				for(i = 0; i < l-1; i++){
					for(j = l-1; j > i; j--){
						if(Number(u[j-1].score) < Number(u[j].score)){
							aux = u[j-1];
							u[j-1] = u[j];
							u[j] = aux;
						}
					}
				}
			}

			function uguali(el, o){
				if((el.nick == o.nick) && (el.score == o.score) ){
					return true;
				}
				return false;
			}

			function inserisciUtente() {

				var u = JSON.parse(localStorage.utenti);
				var nextpos = u.length;
				var o ={
					nick: MyNomeUtente,
					score: MyPunteggio
				};

				for (el of u) {	//controllo su tutto l array
					if(uguali(el,o)){
						alert("coppia nick-score gia presente");
						return false;
					}
				}
				u[nextpos] = o;
				ordina(u);
				localStorage.utenti = JSON.stringify(u);
				alert("Dati inseriti correttamente");
				return true;
			}

			function rigioca() {
				window.location.href = 'game_Classifica.htm?name='+MyNomeUtente;
				return true;
			}

			function rigiocaNuovoUtente(){
				window.location.href = 'PartiQui.htm';
				return true;
			}

		</script>
	</head>

	<body style="background: url('paper.jpg');" onload="inizializzaClassificaUtenti();">

		<p>
		BRAVO! PREMI INVIA PER INVIARE IL TUO SCORE!
		</p>
		<form name="registrazione" onSubmit="return inserisciUtente();"
		accept-charset="utf-8">
		<input type="submit" value="Invia">
		<input type="button" value="Vedi Classifica" onclick="stampaClassifica();">
		<input type="button" value="Reset Classifica" onclick="resetClassificaUtenti();">

		</form>

		<br>
		<button value="RIGIOCA" onclick="rigioca()"> RIGIOCA </button>
		<button value="RIGIOCA" onclick="rigiocaNuovoUtente()"> RIGIOCA COME NUOVO UTENTE </button>

		<hr/>
			<div id="vistaStorage"></div>
		<hr/>
	</body>
</html>
